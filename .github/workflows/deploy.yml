name: üöÄ Deploy to Beget

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –≤–∏–¥–µ–Ω —Ä—è–¥–æ–º —Å –∫–æ–º–º–∏—Ç–æ–º
    outputs:
      status: ${{ job.status }}
    
    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä—è–¥–æ–º —Å –∫–æ–º–º–∏—Ç–æ–º
    permissions:
      contents: read
      deployments: write
      statuses: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      
      - name: Check if deployment needed
        id: check
        run: |
          # –í—Å–µ–≥–¥–∞ –¥–µ–ø–ª–æ–∏–º –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Manual deployment triggered"
            exit 0
          fi
          
          # –ü—Ä–∏ push - –≤—Å–µ–≥–¥–∞ –¥–µ–ø–ª–æ–∏–º (–º–æ–∂–Ω–æ –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π)
          echo "deploy=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment will proceed for push to main branch"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
          echo "Checking changes..."
          changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if [ -n "$changed_files" ]; then
            echo "Changed files:"
            echo "$changed_files"
          else
            echo "Note: Could not determine changed files, deploying anyway"
          fi
      
      - name: Setup Node.js
        if: steps.check.outputs.deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check.outputs.deploy == 'true'
        run: npm ci
      
      - name: Build theme
        if: steps.check.outputs.deploy == 'true'
        run: npm run build:theme
      
      - name: Check files and structure before deploy
        if: steps.check.outputs.deploy == 'true'
        continue-on-error: true
        run: |
          echo "üì¶ Checking files to deploy:"
          echo ""
          echo "Directory structure:"
          find portfolio-theme -type f -o -type d | sort | head -30
          echo ""
          if [ -d "portfolio-theme/assets/css" ] && [ -n "$(ls -A portfolio-theme/assets/css/*.css 2>/dev/null)" ]; then
            echo "‚úÖ CSS files found:"
            ls -lh portfolio-theme/assets/css/*.css | head -3
          else
            echo "‚ùå CSS files not found!"
          fi
          echo ""
          if [ -d "portfolio-theme/assets/js" ] && [ -n "$(ls -A portfolio-theme/assets/js/*.js 2>/dev/null)" ]; then
            echo "‚úÖ JS files found:"
            ls -lh portfolio-theme/assets/js/*.js | head -3
          else
            echo "‚ö†Ô∏è JS files not found!"
          fi
          echo ""
          if [ -f "portfolio-theme/style.css" ]; then
            echo "‚úÖ Theme style.css found"
          else
            echo "‚ùå Theme style.css not found!"
          fi
          echo ""
          echo "‚úÖ Files are in correct structure (portfolio-theme/assets/css/ and portfolio-theme/assets/js/)"
          echo "‚úÖ Ready for deployment - structure should be preserved"
      
      - name: Verify FTP credentials (without exposing them)
        if: steps.check.outputs.deploy == 'true'
        continue-on-error: true
        run: |
          echo "üîê Checking FTP configuration..."
          if [ -z "${{ secrets.BEGET_FTP_HOST }}" ]; then
            echo "‚ùå ERROR: BEGET_FTP_HOST secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.BEGET_FTP_USER }}" ]; then
            echo "‚ùå ERROR: BEGET_FTP_USER secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.BEGET_FTP_PASSWORD }}" ]; then
            echo "‚ùå ERROR: BEGET_FTP_PASSWORD secret is not set!"
            exit 1
          fi
          echo "‚úÖ FTP credentials are configured"
          echo "üìç Server: ${{ secrets.BEGET_FTP_HOST }}"
          echo "üë§ User: ${{ secrets.BEGET_FTP_USER }}"
          echo "üìÅ Target directory: ekaterina-shul.ru/public_html/wp-content/themes/portfolio-theme/"
      
      - name: Deploy to Beget via FTP
        if: steps.check.outputs.deploy == 'true'
        id: deploy
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.BEGET_FTP_HOST }}
          username: ${{ secrets.BEGET_FTP_USER }}
          password: ${{ secrets.BEGET_FTP_PASSWORD }}
          # –ü—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ekaterina-shul.ru/public_html/wp-content/themes/portfolio-theme/
          # –ü—Ä–æ–±—É–µ–º –ø—É—Ç—å –±–µ–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–ª–µ—à–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç –∫–æ—Ä–Ω—è FTP)
          server-dir: ekaterina-shul.ru/public_html/wp-content/themes/portfolio-theme/
          local-dir: ./portfolio-theme/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/src/**
            **/.DS_Store
            **/Thumbs.db
            **/*.md
            **/*.json
            **/.editorconfig
            **/.eslintrc*
            **/.prettierrc*
            **/vite.config.*
            **/package*.json
            **/*.map
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞
          state-name: deployment-state.json
      
      - name: Show deployment result
        if: always() && steps.check.outputs.deploy == 'true'
        run: |
          echo "=========================================="
          echo "üìä DEPLOYMENT RESULT"
          echo "=========================================="
          echo ""
          echo "Deploy step outcome: ${{ steps.deploy.outcome }}"
          echo "Deploy step conclusion: ${{ steps.deploy.conclusion }}"
          echo ""
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "‚úÖ SUCCESS: Files deployed successfully!"
            echo ""
            echo "üìÅ Files deployed to:"
            echo "   /ekaterina-shul.ru/public_html/wp-content/themes/portfolio-theme/"
            echo ""
            echo "üîç Verify: http://ekaterina-shul.ru/wp-content/themes/portfolio-theme/style.css"
          else
            echo "‚ùå FAILED: Deployment did not complete successfully"
            echo ""
            echo "üìã Common issues:"
            echo "   - FTP connection failed (check BEGET_FTP_HOST, BEGET_FTP_USER, BEGET_FTP_PASSWORD secrets)"
            echo "   - Wrong server path (currently: ekaterina-shul.ru/public_html/wp-content/themes/portfolio-theme/)"
            echo "   - Permission denied"
            echo "   - Server directory doesn't exist"
            echo ""
            echo "üîç Check step 'Deploy to Beget via FTP' above for detailed error logs"
            echo ""
            echo "üí° Troubleshooting tips:"
            echo "   1. Verify FTP credentials in GitHub Secrets"
            echo "   2. Check if the server path is correct"
            echo "   3. Ensure the directory exists on the server"
            echo "   4. Try connecting manually via FTP client to verify access"
          fi
          echo "=========================================="
      
      - name: Final status
        if: always()
        run: |
          echo "=========================================="
          echo "üìä FINAL DEPLOYMENT STATUS"
          echo "=========================================="
          echo ""
          echo "Deployment step outcome: ${{ steps.deploy.outcome }}"
          echo "Deployment check result: ${{ steps.check.outputs.deploy }}"
          echo ""
          
          if [ "${{ steps.check.outputs.deploy }}" == "false" ]; then
            echo "‚è≠Ô∏è  STATUS: SKIPPED - No changes detected"
            echo "Deployment was skipped because no relevant files changed."
            exit 0
          elif [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "‚úÖ FINAL STATUS: SUCCESS"
            exit 0
          elif [ "${{ steps.deploy.outcome }}" == "skipped" ]; then
            echo "‚è≠Ô∏è  STATUS: SKIPPED"
            echo "Deployment step was skipped (likely no changes detected)."
            exit 0
          else
            echo "‚ùå FINAL STATUS: FAILED"
            echo "Deployment did not complete successfully."
            echo "Check step 'Deploy to Beget via FTP' above for details."
            exit 1
          fi
