---
rule_type: always
description: Rules for reliable and high-quality code
---

# Reliability & Code Quality Rules

## Главный принцип: Надежность превыше всего

**При создании сайта приоритет:**
1. ✅ Надежность и стабильность
2. ✅ Качество кода
3. ✅ Производительность
4. ✅ Красота дизайна

---

## Правила надежности

### 1. Проверка данных перед использованием

**Всегда проверять:**
- Существование переменных перед использованием
- Наличие данных в SCF полях
- Корректность типов данных
- Пустые значения

```php
// ✅ Правильно
if( SCF::get('price') ) {
    echo esc_html( SCF::get('price') );
}

// ❌ Неправильно
echo SCF::get('price'); // Может быть пустым
```

### 2. Обработка ошибок

- Использовать try-catch для критичных операций
- Предусматривать fallback значения
- Логировать ошибки в development режиме
- Показывать пользователю понятные сообщения

### 3. Валидация и санитизация

**WordPress функции:**
- `esc_html()` - для текста
- `esc_attr()` - для атрибутов
- `esc_url()` - для URL
- `sanitize_text_field()` - для очистки текста
- `intval()` / `absint()` - для чисел

**Всегда экранировать:**
- Данные из базы данных
- Пользовательский ввод
- Данные из SCF полей
- URL и ссылки

### 4. Проверка зависимостей

- Проверять существование функций WordPress перед использованием
- Проверять активность плагинов (SCF) перед использованием их функций
- Использовать `function_exists()` для кастомных функций
- Предусматривать graceful degradation

---

## Качество кода

### 1. Структура и организация

- **Модульность:** Разбивать код на логические части
- **Повторное использование:** Создавать переиспользуемые компоненты
- **Разделение ответственности:** Отделять логику от представления
- **Template Parts:** Использовать `get_template_part()` для переиспользуемых секций

### 2. Читаемость

- **Именование:**
  - Понятные имена переменных и функций
  - Следовать WordPress naming conventions
  - Использовать префиксы для кастомных функций (тема)

- **Комментарии:**
  - Комментировать сложную логику
  - Указывать назначение функций
  - Документировать SCF поля и их использование

- **Форматирование:**
  - Следовать WordPress Coding Standards
  - Отступы и пробелы единообразно
  - Группировать связанный код

### 3. Производительность

**Оптимизация запросов:**
- Использовать `WP_Query` эффективно
- Избегать лишних запросов к БД
- Использовать transient API для кэширования
- Правильно использовать `wp_reset_postdata()`

**Оптимизация ресурсов:**
- Минификация CSS/JS
- Оптимизация изображений (WebP, lazy loading)
- Правильная последовательность загрузки скриптов
- Использование defer/async где возможно

**Frontend оптимизация:**
- Критический CSS инлайн
- Ленивая загрузка изображений
- Оптимизация анимаций (transform, opacity)
- Минимизация reflow/repaint

### 4. Безопасность

**WordPress безопасность:**
- Использовать nonce для форм
- Проверять user capabilities
- Санитизировать и валидировать все данные
- Использовать prepared statements для SQL

**XSS защита:**
- Всегда экранировать вывод
- Не использовать `eval()`
- Валидировать и санитизировать input

**CSRF защита:**
- Nonce токены для всех форм
- Проверка referrer

---

## Тестирование

### 1. Функциональное тестирование

**Перед завершением функции проверить:**
- [ ] Работает при наличии данных
- [ ] Работает при отсутствии данных
- [ ] Работает с граничными значениями
- [ ] Не ломает существующий функционал
- [ ] Корректно обрабатывает ошибки

### 2. Кроссбраузерность

**Проверять в:**
- Chrome/Edge (последние версии)
- Firefox (последняя версия)
- Safari (последняя версия)
- Mobile браузеры (iOS Safari, Chrome Mobile)

### 3. Адаптивность

- Мобильные устройства (320px+)
- Планшеты (768px+)
- Десктоп (1024px+)
- Большие экраны (1920px+)

### 4. WordPress совместимость

- Совместимость с последней версией WordPress
- Работа с популярными плагинами
- Совместимость с SCF Pro
- Корректная работа с темами

---

## Обратная совместимость

### Правила обновления

1. **Не ломать существующий функционал:**
   - При изменении функций сохранять старую сигнатуру
   - Использовать deprecated функции с предупреждениями
   - Миграция данных при необходимости

2. **Версионирование:**
   - Отслеживать изменения в SCF полях
   - Документировать breaking changes
   - Предусматривать миграционные скрипты

3. **Graceful degradation:**
   - Сайт должен работать даже если SCF не активен
   - Fallback значения для всех критичных данных
   - Корректная обработка отсутствия плагинов

---

## Документация кода

### Обязательная документация

1. **Функции:**
   - Назначение функции
   - Параметры и их типы
   - Возвращаемое значение
   - Пример использования

2. **SCF поля:**
   - Назначение группы полей
   - Где используется
   - Обязательные поля
   - Примеры значений

3. **Кастомные типы записей:**
   - Назначение
   - Связанные поля
   - Шаблоны отображения

4. **Хуки и фильтры:**
   - Что изменяют
   - Когда используются
   - Примеры применения

---

## Контрольный список качества

### Перед коммитом кода проверить:

**Надежность:**
- [ ] Все данные проверяются перед использованием
- [ ] Все данные экранируются перед выводом
- [ ] Обработка ошибок на месте
- [ ] Fallback значения для критичных данных

**Качество:**
- [ ] Код следует WordPress Coding Standards
- [ ] Нет дублирования кода
- [ ] Функции делают одну вещь
- [ ] Понятные имена переменных и функций

**Безопасность:**
- [ ] Все данные санитизированы
- [ ] Все данные экранированы
- [ ] Использованы nonce для форм
- [ ] Проверка capabilities где необходимо

**Производительность:**
- [ ] Нет лишних запросов к БД
- [ ] Изображения оптимизированы
- [ ] CSS/JS минифицированы
- [ ] Используется кэширование где возможно

**Доступность:**
- [ ] Семантический HTML
- [ ] Alt текст для изображений
- [ ] Правильная структура заголовков
- [ ] Keyboard navigation работает

**WordPress:**
- [ ] Использованы стандартные функции WordPress
- [ ] Правильная структура шаблонов
- [ ] Корректная регистрация скриптов/стилей
- [ ] Совместимость с последней версией WP

---

## Принципы разработки

### KISS (Keep It Simple, Stupid)
- Простое решение лучше сложного
- Не усложнять без необходимости
- Понятный код важнее "умного"

### DRY (Don't Repeat Yourself)
- Не дублировать код
- Использовать функции и template parts
- Переиспользовать компоненты

### YAGNI (You Aren't Gonna Need It)
- Не добавлять функционал "на будущее"
- Решать только текущие задачи
- Избегать преждевременной оптимизации

### SOLID принципы
- Single Responsibility (одна функция - одна задача)
- Open/Closed (расширяемость без изменения)
- Liskov Substitution (замена без поломок)
- Interface Segregation (минимальные интерфейсы)
- Dependency Inversion (зависимость от абстракций)

---

## Важные напоминания

- **Надежность > Красота:** Функциональность важнее визуала
- **Проверять дважды:** Всегда проверять существование данных
- **Безопасность обязательна:** Никогда не доверять пользовательскому вводу
- **Тестировать сразу:** Проверять работу после каждого изменения
- **Документировать:** Записывать сложные решения и их причины
